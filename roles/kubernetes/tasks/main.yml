---

- name: install iptables management utils
  yum:
    name: iptables-services
    state: latest

- name: deploy kubernetes.repo template to add kube repo
  template:
    src: kubernetes.repo.j2
    dest: /etc/yum.repos.d/kubernetes.repo
    owner: root
    group: root
    mode: 0644

- name: install kube base packages
  yum:
    name: "{{ item }}"
    state: latest
  with_items: "{{ kube_base_packages }}"

- name: enable kube services
  service:
    name: "{{ item }}"
    enabled: yes
    state: started
  with_items: "{{ kube_base_binaries }}"

- name: enable bridge-nf-iptables via sysctl (required for kubeadm)
  shell: "sysctl net.bridge.bridge-nf-call-iptables=1"
  changed_when: false

- name: enable bridge-nf-iptables autostart (req for kubeadm)
  lineinfile:
    dest: "/etc/sysctl.conf"
    regexp: '^net.bridge.bridge-nf-call-iptables'
    line: "net.bridge.bridge-nf-call-iptables = 1"
